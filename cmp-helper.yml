---
## change ip dhcp helper addr on SVI's and subinterface's 
# doesn't work on ME3400 and won't work on older L2 switches IOS < 12.2(60)
# they don't support commad: sh run | sec interface for gathering facts
#
#
- name: change ip helper addr
  gather_facts: false
  connection: network_cli
  hosts: cmp_routers_restore
  tasks:


  - name: get ios facts min
    ios_facts:
      gather_subset: min

      # - debug: var=ansible_net_version
  - debug: 
      msg:
        - "{{ansible_net_model}}"
        - "{{ansible_net_version}}"

  - fail: 
      msg: "platform not suitable"
    when:  ansible_net_model is regex("(?i)Nexus")
   

  - name: get ios facts L3 int
    ios_facts:
      gather_network_resources: l3_interfaces

  - name: find interfaces suitable for change of the helper
    set_fact:
      helper_int: "{{ helper_int|default([]) + [ item.key ] }}"
    loop: "{{ansible_net_interfaces | dict2items}}"
    when: ((item.value.ipv4.0.address is defined) and (item.value.ipv4.0.address is regex("192.168.") ) and (item.key is not regex("Loopback") ))


  - debug: 
      var: helper_int

      # ansible_net_interfaces does not contain info about a current helper, it cannot be verified this way
      # beware: 
      #   https://github.com/ansible/ansible/issues/18966
      #   https://github.com/ansible/ansible/issues/29464
#  - name: check current helper
#    ios_command:
#      commands:
#        "show run interface {{item}} | include ^ ip helper-address"
#    loop: "{{helper_int}}"
#    register: curr_helpers
#
#    # output is quite complicated json dictionary
#  - debug:
#      var: curr_helpers.results | type_debug
#
#  - debug:
#      var: curr_helpers.results[0].stdout
#  - debug:
#      var: curr_helpers.results[0].item | type_debug
#
#
#  ## it doesn't work, too complicated
#  #todo: json_query / query to help
#  # "curr_helpers.results[0].item | type_debug": "AnsibleUnsafeText"
#  - name: remove any old helpers
#    ios_config:
#      lines:
#        - no ip helper-address
#      parents: "{{interface item }}"
#    loop: "{{query('list' , curr_helpers).results[0].item  }}"
#      #loop: "{{ curr_helpers | json_query('results[0].item' , wantlist=True ) }}"
#      #loop: "{{ [ curr_helpers.results[0].item ] }}"
#    when: ( curr_helpers.results[0].stdout is regex("192.168.10.1") or curr_helpers.results[0].stdout is regex("192.168.10.5") or curr_helpers.results[0].stdout is regex("192.168.10.6")   )
#      

  - name: remove all helpers
    ios_config:
      lines:
        - no ip helper-address
      parents: "interface {{item}}"
    loop: "{{helper_int }}" 




  - name: change helper address to current one
    ios_config:
      lines:
        - ip helper-address 192.168.10.248
      parents: "interface {{item}}"
    loop: "{{helper_int }}" 


  - name: save config
    ios_config:
      save_when: always

      
      ### example outputs:
            #"curr_helpers": {
            #      "changed": false,
            #      "msg": "All items completed",
            #      "results": [
            #          {
            #              "ansible_loop_var": "item",
            #              "changed": false,
            #              "failed": false,
            #              "invocation": {
            #                  "module_args": {
            #                      "commands": [
            #                          "show run interface Vlan100 | include ^ ip helper-address"
            #                      ],
            #                      "interval": 1,
            #                      "match": "all",
            #                      "provider": null,
            #                      "retries": 10,
            #                      "wait_for": null
            #                  }
            #              },
            #              "item": "Vlan100",
            #              "stdout": [
            #                  "ip helper-address 192.168.10.248"
            #              ],
            #              "stdout_lines": [
            #                  [
            #                      "ip helper-address 192.168.10.248"
            #                  ]
            #              ]
            #          }
            #      ]
            #  }
            #}
            #
